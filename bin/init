#!/bin/bash
PROGNAME=${0##*/}
usage() {
  echo "Usage: ${PROGNAME} [-n] [-h]"
}

help_message() {
  cat <<- EOF
	${PROGNAME}
	
	Download nextflow and viash binaries into the 'bin' folder

	$(usage)

	Options:
	-n		Download viash only.
	-h		Display this help message and exit.

	EOF
}

only_viash=false
while getopts ":hn" opt; do
  case ${opt} in
    h ) help_message
        exit 0;
        ;;
    n ) only_viash=true
        ;;
    \? ) >&2 echo "Invalid Option: -${OPTARG}" 1>&2
         help_message
         exit 1;
         ;;
    : )
         >&2 echo "Invalid Option: -${OPTARG} requires an argument" 1>&2
         help_message
         exit 1
         ;;
  esac
done


# get the root of the directory
REPO_ROOT=$(git rev-parse --show-toplevel)

# ensure that the command below is run from the root of the repository
cd "$REPO_ROOT"

curl -fsSL get.viash.io | bash -s -- --tools true

if [ "$only_viash" = false ] ; then

  # automatically export the workflow helper
  WF_UTILS=workflows/utils
  [[ -d $WF_UTILS ]] || mkdir -p $WF_UTILS
  bin/viash export resource platforms/nextflow/ProfilesHelper.config > $WF_UTILS/ProfilesHelper.config
  bin/viash export resource platforms/nextflow/WorkflowHelper.nf > $WF_UTILS/WorkflowHelper.nf
  bin/viash export resource platforms/nextflow/DataflowHelper.nf > $WF_UTILS/DataflowHelper.nf

  cd bin

  curl -s https://get.nextflow.io | bash

fi