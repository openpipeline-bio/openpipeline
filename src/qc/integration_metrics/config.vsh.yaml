functionality:
  name: integration_metrics
  namespace: "qc"
  description: |
    Add integration qc metrics to an .h5mu file.

    The metrics are generated using the scib library and stored in the uns column:
      - nmi_score: scib.metrics.nmi
      - ari_score: scib.metrics.ari
      - asw_batch: scib.metrics.silhouette_batch
      - asw_label: scib.metrics.silhouette
      - pcr_score: scib.metrics.pcr_comparison
      - graph_connectivity: scib.metrics.graph_connectivity
      - avg_bio: mean of nmi_score, ari_score and asw_label
      
  authors:
    - __merge__: /src/authors/dorien_roosen.yaml
      roles: [ author ]
  argument_groups:
    - name: Inputs
      arguments:
        - name: "--input"
          type: file
          description: Input h5mu file
          direction: input
          required: true
          example: input.h5mu
        - name: "--modality"
          type: string
          default: "rna"
        - name: "--obsm_embeddings"
          type: string
          required: true
          example: "X_scGPT"
          description: |
            The name of the adata.obsm array containing scGPT cell embeddings.
        - name: "--obs_batch_label"
          type: string
          example: "sample"
          required: true
          description: |
            The name of the adata obs column containing the batch labels.
        - name: "--obs_cell_label"
          type: string
          example: "cell_type"
          required: true
          description: |
            The name of the adata obs column containing the cell type labels.
        - name: "--obs_cluster"
          type: string
          example: "cluster"
          required: true
          description: |
            The name of the adata obs column containing the cluster labels.
        - name: "--uns_neighbors"
          type: string
          example: "neighbors"
          required: true
          description:
            The name of the adata uns object containing the neighbors information.
        - name: "--obsp_neighbor_connectivities"
          type: string
          example: "connectivities"
          required: true
          description: |
            The name of the adata obsp object containing the neighbor connectivities.


    - name: Outputs
      arguments:
        - name: "--output"
          type: file
          description: Output h5mu file.
          direction: output
          example: output.h5mu
        - name: "--output_compression"
          type: string
          description: The compression format to be used on the output h5mu object.
          choices: ["gzip", "lzf"]
          required: false
          example: "gzip"

  resources:
    - type: python_script
      path: script.py
  #   - path: /src/utils/setup_logger.py
  # test_resources:
  #   - type: python_script
  #     path: test.py
  #   - path: /resources_test/pbmc_1k_protein_v3/pbmc_1k_protein_v3_filtered_feature_bc_matrix.h5mu
platforms:
  - type: docker
    image: python:3.11
    setup:
      - type: apt
        packages: 
          - procps
          - libhdf5-dev
          - gfortran
          - cmake
          - libopenblas-dev
      - type: python
        __merge__: [ /src/base/requirements/anndata_mudata.yaml ]
      - type: python
        packages:
          - scib==1.1.5

    test_setup:
      - type: python
        __merge__: [ /src/base/requirements/viashpy.yaml, .]
  - type: nextflow
    directives:
      label: [singlecpu, lowmem]