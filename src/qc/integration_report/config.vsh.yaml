functionality:
  name: integration_report
  namespace: "qc"
  description: |
    Generates a .md file containing an overview of integration metrics (calculated in qc/integration_metrics) and umap visualizations.
      
  authors:
    - __merge__: /src/authors/dorien_roosen.yaml
      roles: [ author ]
  argument_groups:
    - name: Inputs
      arguments:
        - name: "--input"
          type: file
          description: Input h5mu file
          direction: input
          required: true
          example: input.h5mu
        - name: "--modality"
          type: string
          default: "rna"
        - name: "--var_gene_names"
          type: string
          required: false
          description: |
            The name of the adata var column containing gene names. When no gene_name_layer is provided, the var index will be used.
        - name: "--obs_batch_label"
          type: string
          example: "sample"
          required: true
          description: |
            The name of the adata obs column containing the batch labels.
        - name: "--obs_cell_label"
          type: string
          example: "cell_type"
          required: true
          description: |
            The name of the adata obs column containing the cell type labels.
        - name: "--uns_neighbors"
          type: string
          example: "neighbors"
          required: true
          description:
            The name of the adata uns object containing the neighbors information.
        - name: "--obsm_umap"
          type: string
          example: "X_scGPT_umap"
          required: true
          description: "The obsm slot containing UMAP embeddings."

    - name: Outputs
      arguments:
        - name: "--output"
          type: file
          required: true
          description: Name of the integration qc output pdf report.
          direction: output
          example: output.pdf
        - name: "--output_raw"
          type: boolean_true
          description: |
            If provided, the raw data (unrendered report (md), figures (png) and metrics (json)) will be published.
        - name: "--output_umap_label_fig"
          type: file
          direction: output
          default: umap_label.png
          must_exist: False
          description: |
            Name of the UMAP label figure (png). Will only be saved if --output_raw is set to true.
        - name: "--output_umap_batch_fig"
          type: file
          direction: output
          must_exist: False
          default: umap_batch.png
          description: |
            Name of the UMAP batch figure (png). Will only be saved if --output_raw is set to true.
        - name: "--output_md_report"
          type: file
          direction: output
          default: report.qmd
          must_exist: False
          description: |
            Name of the unrendered report file (qmd). Will only be saved if --output_raw is set to true.
        - name: "--output_metrics"
          type: file
          direction: output
          must_exist: False
          default: metrics.json
          description: |
            Name of the json file containing integration metrics (json). Will only be saved if --output_raw is set to true.       

  resources:
    - type: python_script
      path: script.py
    - path: report_template.md
   
platforms:
  - type: docker
    image: python:3.11
    setup:
      - type: apt
        packages: 
          - procps
          - libhdf5-dev
          - gfortran
          - cmake
          - libopenblas-dev
      - type: python
        __merge__: [ /src/base/requirements/anndata_mudata.yaml, /src/base/requirements/scanpy.yaml ]
      - type: docker
        run: |
          wget https://github.com/quarto-dev/quarto-cli/releases/download/v1.4.549/quarto-1.4.549-linux-amd64.deb -O /tmp/quarto.deb && \
          dpkg -i /tmp/quarto.deb && \
          rm /tmp/quarto.deb && \
          quarto install tinytex

    test_setup:
      - type: python
        __merge__: [ /src/base/requirements/viashpy.yaml, .]
  - type: nextflow
    directives:
      label: [singlecpu, lowmem]