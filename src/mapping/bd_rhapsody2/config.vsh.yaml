functionality:
  name: "bd_rhapsody2"
  namespace: "mapping"
  description: |
    BD Rhapsody Sequence Analysis CWL pipeline v2.2.1
    
    This pipeline performs analysis of single-cell multiomic sequence read (FASTQ) data. The supported
    sequencing libraries are those generated by the BD Rhapsody assay kits, including: Whole Transcriptome
    mRNA, Targeted mRNA, AbSeq Antibody-Oligonucleotides, Single-Cell Multiplexing, TCR/BCR, and
    ATAC-Seq

    The CWL pipeline file is obtained by cloning 'https://bitbucket.org/CRSwDev/cwl' and removing all objects with class 'DockerRequirement' from the YAML.
  info:
    keywords: [rna-seq, single-cell, multiomic, atac-seq, targeted, abseq, tcr, bcr]
    links:
      repository: https://bitbucket.org/CRSwDev/cwl/src/master/v2.2.1
      documentation: https://bd-rhapsody-bioinfo-docs.genomics.bd.com
    license: Unknown
  authors:
    - __merge__: /src/authors/robrecht_cannoodt.yaml
      roles: [ author, maintainer ]
    - __merge__: /src/authors/weiwei_schultz.yaml
      roles: [ contributor ]

  argument_groups:
  - name: Inputs
    arguments:
      - name: "--reads"
        type: file
        description: |
          Reads (optional) - Path to your FASTQ.GZ formatted read files from libraries that may include:
          
          - WTA mRNA
          - Targeted mRNA
          - AbSeq
          - Sample Multiplexing
          - VDJ
          
          You may specify as many R1/R2 read pairs as you want.
        required: false
        multiple: true
        example:
          - WTALibrary_S1_L001_R1_001.fastq.gz
          - WTALibrary_S1_L001_R2_001.fastq.gz
        info:
          config_key: Reads
      - name: "--reads_atac"
        type: file
        description: |
          Path to your FASTQ.GZ formatted read files from ATAC-Seq libraries.
          You may specify as many R1/R2/I2 files as you want.
        required: false
        multiple: true
        example:
          - ATACLibrary_S2_L001_R1_001.fastq.gz
          - ATACLibrary_S2_L001_R2_001.fastq.gz
          - ATACLibrary_S2_L001_I2_001.fastq.gz
        info:
          config_key: Reads_ATAC
  - name: References
    description: |
      Assay type will be inferred from the provided reference(s).
      Do not provide both reference_archive and targeted_reference at the same time.
      
      Valid reference input combinations:
        - reference_archive: WTA only
        - reference_archive & abseq_reference: WTA + AbSeq
        - reference_archive & supplemental_reference: WTA + extra transgenes
        - reference_archive & abseq_reference & supplemental_reference: WTA + AbSeq + extra transgenes
        - reference_archive: WTA + ATAC or ATAC only
        - reference_archive & supplemental_reference: WTA + ATAC + extra transgenes
        - targeted_reference: Targeted only
        - targeted_reference & abseq_reference: Targeted + AbSeq
        - abseq_reference: AbSeq only

      The reference_archive can be generated with the bd_rhapsody_make_reference component.
      Alternatively, BD also provides standard references which can be downloaded from these locations:

        - Human: https://bd-rhapsody-public.s3.amazonaws.com/Rhapsody-WTA/Pipeline-version2.x_WTA_references/RhapRef_Human_WTA_2023-02.tar.gz
        - Mouse: https://bd-rhapsody-public.s3.amazonaws.com/Rhapsody-WTA/Pipeline-version2.x_WTA_references/RhapRef_Mouse_WTA_2023-02.tar.gz
    arguments:
      - name: "--reference_archive"
        type: file
        description: |
          Path to Rhapsody WTA Reference in the tar.gz format.

          Structure of the reference archive:
          
          - `BD_Rhapsody_Reference_Files/`: top level folder
            - `star_index/`: sub-folder containing STAR index, that is files created with `STAR --runMode genomeGenerate`
            - GTF for gene-transcript-annotation e.g. "gencode.v43.primary_assembly.annotation.gtf"
        example: "RhapRef_Human_WTA_2023-02.tar.gz"
        required: false
        info:
          config_key: Reference_Archive
      - name: "--targeted_reference"
        type: file
        description: |
          Path to the targeted reference file in FASTA format.
        example: "BD_Rhapsody_Immune_Response_Panel_Hs.fasta"
        multiple: true
        info:
          config_key: Targeted_Reference
      - name: "--abseq_reference"
        type: file
        description: Path to the AbSeq reference file in FASTA format.  Only needed if BD AbSeq Ab-Oligos are used.
        example: "AbSeq_reference.fasta"
        multiple: true
        info:
          config_key: AbSeq_Reference
      - name: "--supplemental_reference"
        type: file
        alternatives: [-s]
        description: Path to the supplemental reference file in FASTA format.  Only needed if there are additional transgene sequences to be aligned against in a WTA assay experiment.
        example: "supplemental_reference.fasta"
        multiple: true
        info:
          config_key: Supplemental_Reference
  - name: Outputs
    description: Outputs for all pipeline runs
    arguments:
      - name: "--output_dir"
        type: file
        direction: output
        alternatives: [-o]
        description: "The unprocessed output directory containing all the outputs from the pipeline."
        required: true
        example: output_dir/
      - name: "--output_seurat"
        type: file
        direction: output
        description: "Single-cell analysis tool inputs. Seurat .rds input file containing RSEC molecules data table and all cell annotation metadata."
        example: output_seurat.rds
        required: false
        info:
          template: "sample_Seurat.rds"
      # - name: "--output_mudata"
      #   type: file
      #   direction: output
      #   description: "Single-cell analysis tool inputs. Scanpy / Muon input file containing RSEC molecules data table and all cell annotation metadata."
      #   example: output_mudata.h5mu
      #   required: false
      #   info:
      #     template: "[sample_name].h5mu"
      # - name: "--metrics_summary"
      #   type: file
      #   direction: output
      #   description: "Metrics Summary. Report containing sequencing, molecules, and cell metrics."
      #   example: metrics_summary.csv
      #   required: false
      #   info:
      #     template: "[sample_name]_Metrics_Summary.csv"
      # - name: "--pipeline_report"
      #   type: file
      #   direction: output
      #   description: "Pipeline Report. Summary report containing the results from the sequencing analysis pipeline run."
      #   example: pipeline_report.html
      #   required: false
      #   info:
      #     template: "[sample_name]_Pipeline_Report.html"
      # - name: "--rsec_mols_per_cell"
      #   type: file
      #   direction: output
      #   description: "Molecules per bioproduct per cell bassed on RSEC"
      #   example: RSEC_MolsPerCell_MEX.zip 
      #   required: false
      #   info:
      #     template: "[sample_name]_RSEC_MolsPerCell_MEX.zip"
      # - name: "--dbec_mols_per_cell"
      #   type: file
      #   direction: output
      #   description: "Molecules per bioproduct per cell bassed on DBEC. DBEC data table is only output if the experiment includes targeted mRNA or AbSeq bioproducts."
      #   example: DBEC_MolsPerCell_MEX.zip 
      #   required: false
      #   info:
      #     template: "[sample_name]_DBEC_MolsPerCell_MEX.zip"
      # - name: "--rsec_mols_per_cell_unfiltered"
      #   type: file
      #   direction: output
      #   description: "Unfiltered tables containing all cell labels with â‰¥10 reads."
      #   example: RSEC_MolsPerCell_Unfiltered_MEX.zip 
      #   required: false
      #   info:
      #     template: "[sample_name]_RSEC_MolsPerCell_Unfiltered_MEX.zip"
      # - name: "--bam"
      #   type: file
      #   direction: output
      #   description: "Alignment file of R2 with associated R1 annotations for Bioproduct."
      #   example: BioProduct.bam
      #   required: false
      #   info:
      #     template: "[sample_name]_Bioproduct.bam"
      # - name: "--bam_inddex"
      #   type: file
      #   direction: output
      #   description: "Index file for the alignment file."
      #   example: BioProduct.bam.bai
      #   required: false
      #   info:
      #     template: "[sample_name]_Bioproduct.bam.bai"
      # - name: "--bioproduct_stats"
      #   type: file
      #   direction: output
      #   description: "Bioproduct Stats. Metrics from RSEC and DBEC Unique Molecular Identifier adjustment algorithms on a per-bioproduct basis."
      #   example: Bioproduct_Stats.csv
      #   required: false
      #   info:
      #     template: "[sample_name]_Bioproduct_Stats.csv"
      # - name: "--dimred_tsne"
      #   type: file
      #   direction: output
      #   description: "t-SNE dimensionality reduction coordinates per cell index"
      #   example: tSNE_coordinates.csv
      #   required: false
      #   info:
      #     template: "[sample_name]_(assay)_tSNE_coordinates.csv"
      # - name: "--dimred_umap"
      #   type: file
      #   direction: output
      #   description: "UMAP dimensionality reduction coordinates per cell index"
      #   example: UMAP_coordinates.csv
      #   required: false
      #   info:
      #     template: "[sample_name]_(assay)_UMAP_coordinates.csv"
      # - name: "--immune_cell_classification"
      #   type: file
      #   direction: output
      #   description: "Immune Cell Classification. Cell type classification based on the expression of immune cell markers."
      #   example: Immune_Cell_Classification.csv
      #   required: false
      #   info:
      #     template: "[sample_name]_(assay)_cell_type_experimental.csv"

  resources:
    - type: python_script
      path: script.py
    - path: rhapsody_pipeline_2.2.1_nodocker.cwl 
  test_resources:
    - type: python_script
      path: test.py
    - path: make_rhap_reference_2.2.1_nodocker.cwl
      dest: bd_rhapsody_make_reference.cwl
    - path: rhapsody_cell_label.py
    - path: /resources_test/reference_gencodev41_chr1/reference.fa.gz
    - path: /resources_test/reference_gencodev41_chr1/reference.gtf.gz

platforms:
  - type: docker
    image: ghcr.io/data-intuitive/bd_rhapsody:1.10.1
    setup:
      - type: python
        packages:
          - pandas<2
  - type: nextflow
    directives:
      label: [ highmem, highcpu ]
